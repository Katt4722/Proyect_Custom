import os
import base64
import telebot
from dotenv import load_dotenv
from groq import Groq
import requests
import re
#--------------------------------------
env_path = r"C:\Users\Equipo\Documents\proyecto samsung\Proyect_Custom\.env"
load_dotenv(dotenv_path=env_path)

TOKEN_BOT_TELEGRAM = os.getenv("TELEGRAM_BOT_TOKEN")
CLAVE_API_GROQ = os.getenv("GROQ_API_KEY")

if not TOKEN_BOT_TELEGRAM or not CLAVE_API_GROQ:
    raise ValueError("‚ö†Ô∏è Faltan variables TELEGRAM_BOT_TOKEN o GROQ_API_KEY en el archivo .env")

bot = telebot.TeleBot(TOKEN_BOT_TELEGRAM)
groq_client = Groq(api_key=CLAVE_API_GROQ)
#--------------------------------------
PROMPT_ASESOR_MODA = """
Eres un Asesor de Moda Personal experto en estilo, colorimetr√≠a y comercio electr√≥nico. 
Analiza la imagen que te doy y responde con:
1Ô∏è‚É£ Breve descripci√≥n general.
2Ô∏è‚É£ An√°lisis de moda (tipo, estilo, colores).
3Ô∏è‚É£ Recomendaciones de prendas o accesorios que combinen.
"""

PROMPT_MODA_TEXTO = """
Eres un asistente virtual experto en moda y tendencias. 
Responde preguntas del usuario sobre prendas, combinaciones, precios, lugares donde comprar o conseguirlo,
usando un tono amable, breve y natural.
"""
#-------------------------------------
@bot.message_handler(commands=["start"])
def start(message):
    bot.reply_to(
        message,
        "(…î‚óî‚Äø‚óî)…î ‚ô•¬°Hola! Soy tu asesor de moda virtual.‚ù§\n\n"
        "üì∏ Env√≠ame una foto para analizar tu looküôà o \n"
        "üòâüí¨ Escribime algo como:\n"
        "- '¬øD√≥nde puedo comprar un vestido rojo?'\n"
        "- 'Tiendas con camperas de cuero'\n"
        "- 'Ropa parecida a esta foto'"
    )
#------------------------------------------
def buscar_en_web(message):
    try:
        consulta = message.text.strip()
        bot.reply_to(message, f"üåüPensando la respuesta sobre: <b>{consulta}</b> ...", parse_mode="HTML")

        url = "https://html.duckduckgo.com/html/"
        params = {"q": consulta}
        headers = {"User-Agent": "Mozilla/5.0"}
        r = requests.get(url, params=params, headers=headers, timeout=10)

        enlaces = re.findall(r'<a rel="nofollow" class="result__a" href="(.*?)">', r.text)
        enlaces_validos = []

        for link in enlaces:
            if "duckduckgo" in link:
                continue
            try:
                test = requests.head(link, allow_redirects=True, timeout=5)
                if test.status_code == 200:
                    enlaces_validos.append(link)
            except:
                continue

        resultados = enlaces_validos[:5]  # Limitar a los primeros 5 links v√°lidos

        if resultados:
            lista_links = "\n".join([f"{i+1}. {link}" for i, link in enumerate(resultados)])
            texto_para_resumir = "\n".join(resultados)

            response = groq_client.chat.completions.create(
                model="meta-llama/llama-4-scout-17b-16e-instruct",
                messages=[
                    {"role": "system", "content": "Eres un experto en moda que resume brevemente resultados web para el usuario."},
                    {"role": "user", "content": f"üéÄEstos son los resultados que encontre para ti:\n{texto_para_resumir}\n\nResume brevemente qu√© tiendas o productos hay."}
                ],
                max_completion_tokens=400,
            )

            resumen = response.choices[0].message.content
            bot.reply_to(
                message,
                f"üõçÔ∏è <b>Tiendas encontradas (verificadas y activas):</b>\n{lista_links}\n\nüß† <b>Resumen:</b> {resumen}",
                parse_mode="HTML"
            )
        else:
           
            response = groq_client.chat.completions.create(
                model="meta-llama/llama-4-scout-17b-16e-instruct",
                messages=[
                    {"role": "system", "content": "Eres un experto en moda y compras online."},
                    {"role": "user", "content": f"No encontr√© enlaces v√°lidosüò®, pero necesito que recomiendes tiendas o lugares donde conseguir {consulta} en Argentina o por internet.üòåüíã"}
                ],
                max_completion_tokens=400,
            )

            respuesta = response.choices[0].message.content
            bot.reply_to(message, f"(>‚Äø‚ó†)‚úå <b>Sugerencias:</b>\n{respuesta}", parse_mode="HTML")

    except Exception as e:
        bot.reply_to(message, f"‚ö†Ô∏è Error al buscar en la web:\n{str(e)}")
#-------------------------------------
@bot.message_handler(content_types=["photo"])
def analizar_imagen(message):
    try:
        file_info = bot.get_file(message.photo[-1].file_id)
        downloaded_file = bot.download_file(file_info.file_path)
        image_base64 = base64.b64encode(downloaded_file).decode("utf-8")

        bot.reply_to(message, "üíåAnalizando tu imagen...‚è± ")

        response = groq_client.chat.completions.create(
            model="meta-llama/llama-4-scout-17b-16e-instruct",
            messages=[
                {"role": "system", "content": PROMPT_ASESOR_MODA},
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": "Analiza esta imagen de ropa y aplica el prompt anterior."},
                        {"type": "image_url", "image_url": {"url": f"data:image/jpeg;base64,{image_base64}"}}
                    ]
                }
            ],
        )

        resultado = response.choices[0].message.content
        bot.reply_to(message, f"üíå <b>An√°lisis de la imagen:</b>\n{resultado}", parse_mode="HTML")

        return  

    except Exception as e:
        bot.reply_to(message, f"‚ö†Ô∏è Error al procesar la imagen:\n{str(e)}")
        return  
#-------------------------------------
@bot.message_handler(content_types=["text"])
def manejar_texto(message):
    consulta = message.text.lower().strip()

    if any(p in consulta for p in ["precio", "comprar", "d√≥nde", "donde", "argentina", "caba", "local", "tienda", "shop", "online", "marca", "outlet", "barato", "env√≠o", "link", "venden", "venta", "mercado libre", "cat√°logo","cu√°nto esta", "cuanto esta", "valor","",]):
        buscar_en_web(message)
        return

    if any(p in consulta for p in ["parecida", "similar", "igual a", "como esta", "recomendame", "combinar", "usar con", "inspiraci√≥n", "estilo", "look", "opciones", "conjuntos", "me queda bien", "qu√© usar", "recomiendas", "outfit"]):
        response = groq_client.chat.completions.create(
            model="meta-llama/llama-4-scout-17b-16e-instruct",
            messages=[
                {"role": "system", "content": PROMPT_MODA_TEXTO},
                {"role": "user", "content": consulta}
            ],
            max_completion_tokens=400,
        )
        respuesta = response.choices[0].message.content
        bot.reply_to(message, f"üòòüí¨ <b>{respuesta}</b>", parse_mode="HTML")
        return

    buscar_en_web(message)
#-------------------------------------
print("ü§ñ Bot de asesor de moda con b√∫squeda real y an√°lisis de imagen iniciado correctamente...")
bot.polling()
